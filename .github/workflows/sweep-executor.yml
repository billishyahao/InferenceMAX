name: Template - Sweep Executor

on:
  workflow_call:
    inputs:
      pr-number:
        required: true
        type: string
      generator-args:
        required: true
        type: string

permissions:
  contents: read

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      search-space-config: ${{ steps.generate.outputs.search-space-config }}
      is-multinode: ${{ steps.detect.outputs.is-multinode }}
    steps:
      - name: Checkout PR head
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: refs/pull/${{ inputs.pr-number }}/head

      - name: Detect node type from args
        id: detect
        run: |
          set -euo pipefail
          ARGS=${{ inputs.generator-args }}
          if [[ "$ARGS" == *"--multi-node"* ]]; then
            echo "is-multinode=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-multinode=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate sweep configs
        id: generate
        shell: python
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          import json, os, shlex, subprocess, sys

          cmd_args = r'''${{ inputs.generator-args }}'''
          script = os.path.join(os.environ['GITHUB_WORKSPACE'], 'utils', 'matrix_logic', 'generate_sweep_configs.py')
          cfg_amd = os.path.join(os.environ['GITHUB_WORKSPACE'], '.github', 'configs', 'amd-master.yaml')
          cfg_nv = os.path.join(os.environ['GITHUB_WORKSPACE'], '.github', 'configs', 'nvidia-master.yaml')
          runners = os.path.join(os.environ['GITHUB_WORKSPACE'], '.github', 'configs', 'runners.yaml')

          subprocess.run([sys.executable, '-m', 'pip', 'install', 'pydantic'], check=True)

          argv = [sys.executable, script]
          if cmd_args.strip():
              argv += shlex.split(cmd_args)
          argv += ['--config-files', cfg_amd, cfg_nv, '--runner-config', runners]

          print('Invoking:', ' '.join(shlex.quote(a) for a in argv))
          res = subprocess.run(argv, capture_output=True, text=True)
          if res.returncode != 0:
              print('Generator failed. stdout:\n', res.stdout)
              print('stderr:\n', res.stderr, file=sys.stderr)
              raise SystemExit(res.returncode)

          try:
              data = json.loads(res.stdout)
          except Exception as e:
              print('Failed to parse generator output as JSON:', e, file=sys.stderr)
              print('Raw output:\n', res.stdout)
              raise

          print(f"Generated {len(data)} configs")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write('search-space-config=' + json.dumps(data) + '\n')

  run-single-node:
    needs: generate
    if: ${{ needs.generate.result == 'success' && needs.generate.outputs.search-space-config != '[]' && needs.generate.outputs.is-multinode == 'false' }}
    uses: ./.github/workflows/benchmark-tmpl.yml
    name: Sweep (Single-Node)
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.generate.outputs.search-space-config) }}
    secrets: inherit
    with:
      exp-name: ${{ matrix.config.exp-name }}
      isl: ${{ matrix.config.isl }}
      osl: ${{ matrix.config.osl }}
      max-model-len: ${{ matrix.config.max-model-len }}
      runner: ${{ matrix.config.runner }}
      image: ${{ matrix.config.image }}
      model: ${{ matrix.config.model }}
      model-prefix: ${{ matrix.config.model-prefix }}
      framework: ${{ matrix.config.framework }}
      precision: ${{ matrix.config.precision }}
      tp: ${{ matrix.config.tp }}
      ep: ${{ matrix.config.ep }}
      dp-attn: ${{ matrix.config.dp-attn }}
      conc: ${{ matrix.config.conc }}
      spec-decoding: ${{ matrix.config.spec-decoding }}
      disagg: ${{ matrix.config.disagg }}

  run-multi-node:
    needs: generate
    if: ${{ needs.generate.result == 'success' && needs.generate.outputs.search-space-config != '[]' && needs.generate.outputs.is-multinode == 'true' }}
    uses: ./.github/workflows/benchmark-multinode-tmpl.yml
    name: Sweep (Multi-Node)
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.generate.outputs.search-space-config) }}
    secrets: inherit
    with:
      exp-name: ${{ matrix.config.exp-name }}
      isl: ${{ matrix.config.isl }}
      osl: ${{ matrix.config.osl }}
      max-model-len: ${{ matrix.config.max-model-len }}
      runner: ${{ matrix.config.runner }}
      image: ${{ matrix.config.image }}
      model: ${{ matrix.config.model }}
      model-prefix: ${{ matrix.config.model-prefix }}
      framework: ${{ matrix.config.framework }}
      precision: ${{ matrix.config.precision }}
      conc-list: ${{ toJson(matrix.config.conc) }}
      spec-decoding: ${{ matrix.config.spec-decoding }}
      disagg: ${{ matrix.config.disagg }}

      prefill-num-worker: ${{ matrix.config.prefill.num-worker }}
      prefill-tp: ${{ matrix.config.prefill.tp }}
      prefill-ep: ${{ matrix.config.prefill.ep }}
      prefill-dp-attn: ${{ matrix.config.prefill.dp-attn }}
      prefill-additional-settings: ${{ toJson(matrix.config.prefill.additional-settings) }}

      decode-num-worker: ${{ matrix.config.decode.num-worker }}
      decode-tp: ${{ matrix.config.decode.tp }}
      decode-ep: ${{ matrix.config.decode.ep }}
      decode-dp-attn: ${{ matrix.config.decode.dp-attn }}
      decode-additional-settings: ${{ toJson(matrix.config.decode.additional-settings) }}

  collect-results:
    needs: [run-single-node, run-multi-node]
    if: ${{ always() && (needs.run-single-node.result == 'success' || needs.run-multi-node.result == 'success') }}
    uses: ./.github/workflows/collect-results.yml
    name: Collect Results
    secrets: inherit
    with:
      exp-name: ''

